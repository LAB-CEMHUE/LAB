<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản lý File Phòng thí nghiệm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body class="bg-gradient-to-br from-green-50 to-emerald-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-green-600">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-flask text-3xl text-green-600"></i>
                    <h1 class="text-2xl font-bold text-gray-800">LAB-CEMHUE</h1>
                </div>
                
                <!-- Daily Sample Counter (Center-Right) -->
                <div class="flex items-center space-x-2 bg-blue-50 px-4 py-2 rounded-lg border border-blue-200">
                    <i class="fas fa-calendar-day text-blue-600"></i>
                    <span class="text-sm font-medium text-blue-800">Mẫu nhận hôm nay: <span id="dailySampleCount" class="font-bold">0</span></span>
                </div>
                
                <!-- Login Section -->
                <div class="flex items-center space-x-4" id="loginSection">
                    <div class="flex items-center space-x-2">
                        <input type="text" id="username" placeholder="Tên đăng nhập" class="px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500 w-24">
                        <input type="password" id="password" placeholder="Mật khẩu" class="px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500 w-20">
                        <select id="userRole" class="px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500 w-20">
                            <option value="">Vai trò</option>
                            <option value="admin">BANISO</option>
                            <option value="director">Giám đốc</option>
                            <option value="lab">Phòng TN</option>
                        </select>
                        <button onclick="handleLogin()" class="bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700 transition-colors text-xs">
                            <i class="fas fa-sign-in-alt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- User Info (shown after login) -->
                <div class="hidden items-center space-x-2" id="userSection">
                    <span class="text-sm text-gray-700">Xin chào, <span id="userInfo" class="font-medium text-green-600"></span></span>
                    <button onclick="logout()" class="text-red-600 hover:text-red-800 text-sm">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-green-600 shadow-md">
        <div class="container mx-auto px-6">
            <div class="flex space-x-8">
                <button onclick="showSection('dashboard')" class="nav-btn active px-4 py-3 text-white hover:bg-green-700 transition-colors">
                    <i class="fas fa-tachometer-alt mr-2"></i>Tổng quan
                </button>

                <button onclick="showSection('coding')" class="nav-btn px-4 py-3 text-white hover:bg-green-700 transition-colors">
                    <i class="fas fa-barcode mr-2"></i>Mã hóa
                </button>
                <button onclick="showSection('analysis')" class="nav-btn px-4 py-3 text-white hover:bg-green-700 transition-colors">
                    <i class="fas fa-microscope mr-2"></i>Thử nghiệm
                </button>
                <button onclick="showSection('results')" class="nav-btn px-4 py-3 text-white hover:bg-green-700 transition-colors">
                    <i class="fas fa-chart-line mr-2"></i>Kết quả
                </button>
                <button onclick="showSection('customers')" class="nav-btn px-4 py-3 text-white hover:bg-green-700 transition-colors">
                    <i class="fas fa-users mr-2"></i>Khách hàng
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Dashboard Section -->
        <div id="dashboard" class="section">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">

                <div class="bg-blue-500 rounded-lg shadow-md p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-blue-100">Số mẫu nhận</p>
                            <p class="text-2xl font-bold text-white" id="codingFilesCount">0</p>
                        </div>
                        <i class="fas fa-vial text-3xl text-blue-200"></i>
                    </div>
                </div>
                <div class="bg-orange-500 rounded-lg shadow-md p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-orange-100">Số mẫu thử nghiệm</p>
                            <p class="text-2xl font-bold text-white" id="analysisFilesCount">0</p>
                        </div>
                        <i class="fas fa-microscope text-3xl text-orange-200"></i>
                    </div>
                </div>
                <div class="bg-purple-500 rounded-lg shadow-md p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-purple-100">Phiếu kết quả thử nghiệm</p>
                            <p class="text-2xl font-bold text-white" id="resultFilesCount">0</p>
                        </div>
                        <i class="fas fa-file-medical text-3xl text-purple-200"></i>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">File được tải lên gần đây</h2>
                    <div id="recentUploads" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">Chưa có file nào được tải lên</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Hướng dẫn sử dụng</h2>
                    <div class="space-y-4 text-sm text-gray-600">
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-barcode text-green-500 mt-1"></i>
                            <div>
                                <p class="font-medium text-gray-800">Mã hóa</p>
                                <p>Tải lên file Excel/CSV chứa mã mẫu thử nghiệm</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-microscope text-yellow-500 mt-1"></i>
                            <div>
                                <p class="font-medium text-gray-800">Thử nghiệm</p>
                                <p>Tải lên file thử nghiệm và liên kết với mã hóa</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-chart-line text-purple-500 mt-1"></i>
                            <div>
                                <p class="font-medium text-gray-800">Kết quả</p>
                                <p>Tải lên file kết quả và tạo hồ sơ khách hàng</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-users text-blue-500 mt-1"></i>
                            <div>
                                <p class="font-medium text-gray-800">Khách hàng</p>
                                <p>Quản lý thông tin và theo dõi tiến độ khách hàng</p>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <p class="text-xs text-blue-700">
                                <i class="fas fa-info-circle mr-1"></i>
                                <strong>Lưu ý:</strong> Đăng nhập ở góc phải trên để truy cập đầy đủ chức năng
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- Coding Files Section -->
        <div id="coding" class="section hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Tải lên file mã hóa</h2>
                
                <!-- File Code Input -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mã file (theo ngày - VD: 250731)</label>
                    <div class="flex space-x-4">
                        <input type="text" id="codingFileCode" placeholder="Nhập mã file (DDMMYY)" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" maxlength="6">
                        <button onclick="generateFileCode()" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                            <i class="fas fa-calendar mr-2"></i>Tạo mã hôm nay
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Mã file sẽ được sử dụng để liên kết với file thử nghiệm và kết quả</p>
                </div>
                
                <!-- Sample Count Input -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Số mẫu nhận</label>
                    <div class="flex space-x-4">
                        <input type="number" id="sampleCount" placeholder="Nhập số mẫu nhận (VD: 15)" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" min="0" max="1000">
                        <div class="flex items-center px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-sm text-gray-600">
                            <i class="fas fa-vial mr-2"></i>
                            <span>mẫu</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Số lượng mẫu thực tế nhận được trong ngày</p>
                </div>
                
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-green-400 transition-colors" id="codingDropZone">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                    <p class="text-lg text-gray-600 mb-2">Kéo thả file Excel/CSV vào đây hoặc</p>
                    <input type="file" id="codingFileInput" class="hidden" multiple accept=".xls,.xlsx,.csv">
                    <button onclick="document.getElementById('codingFileInput').click()" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition-colors">
                        <i class="fas fa-folder-open mr-2"></i>Chọn file
                    </button>
                    <p class="text-sm text-gray-500 mt-2">Hỗ trợ: Excel, CSV (Tối đa 10MB mỗi file)</p>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Danh sách file mã hóa</h2>
                    <div class="flex space-x-2">
                        <input type="text" id="searchCoding" placeholder="Tìm kiếm file..." class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="exportCodingData()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>Xuất dữ liệu
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Mã file</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Tên file</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Số lượng mã</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Kích thước</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Ngày tải lên</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Trạng thái</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="codingFilesTable" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-4 py-8 text-center text-gray-500">Chưa có file nào</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analysis Files Section -->
        <div id="analysis" class="section hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Tải lên file thử nghiệm</h2>
                
                <!-- Link to Coding File -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Liên kết với file mã hóa</label>
                    <select id="analysisLinkedCode" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
                        <option value="">Chọn mã file mã hóa</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Chọn file mã hóa tương ứng để liên kết</p>
                </div>
                
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-yellow-400 transition-colors" id="analysisDropZone">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                    <p class="text-lg text-gray-600 mb-2">Kéo thả file vào đây hoặc</p>
                    <input type="file" id="analysisFileInput" class="hidden" multiple accept=".pdf,.doc,.docx">
                    <button onclick="document.getElementById('analysisFileInput').click()" class="bg-yellow-600 text-white px-6 py-2 rounded-md hover:bg-yellow-700 transition-colors">
                        <i class="fas fa-folder-open mr-2"></i>Chọn file
                    </button>
                    <p class="text-sm text-gray-500 mt-2">Hỗ trợ: PDF, Word (Tối đa 10MB mỗi file)</p>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Danh sách file thử nghiệm</h2>
                    <div class="flex space-x-2">
                        <input type="text" id="searchAnalysis" placeholder="Tìm kiếm file..." class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="filterAnalysisStatus" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả trạng thái</option>
                            <option value="pending">Chờ xử lý</option>
                            <option value="processing">Đang xử lý</option>
                            <option value="completed">Hoàn thành</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Mã liên kết</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Tên file</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Loại</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Kích thước</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Ngày tải lên</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Trạng thái</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="analysisFilesTable" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-4 py-8 text-center text-gray-500">Chưa có file nào</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Results Files Section -->
        <div id="results" class="section hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Tải lên file kết quả</h2>
                
                <!-- Link to Coding File and Customer -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Liên kết với file mã hóa</label>
                        <select id="resultsLinkedCode" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="">Chọn mã file mã hóa</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tên khách hàng</label>
                        <div class="flex space-x-2">
                            <input type="text" id="resultsCustomerName" placeholder="Nhập tên khách hàng" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <button onclick="selectFromCustomerList()" class="bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700 transition-colors" title="Chọn từ danh sách khách hàng">
                                <i class="fas fa-users"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Loại mẫu</label>
                        <select id="resultsSampleType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="">Chọn loại mẫu</option>
                            <option value="sent">Mẫu gửi</option>
                            <option value="regular">Mẫu thường</option>
                        </select>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mb-6">Thông tin này sẽ được sử dụng để tạo hồ sơ tổng hợp cho khách hàng</p>
                
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-purple-400 transition-colors" id="resultsDropZone">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                    <p class="text-lg text-gray-600 mb-2">Kéo thả file vào đây hoặc</p>
                    <input type="file" id="resultsFileInput" class="hidden" multiple accept=".pdf,.doc,.docx,.xls,.xlsx">
                    <button onclick="document.getElementById('resultsFileInput').click()" class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700 transition-colors">
                        <i class="fas fa-folder-open mr-2"></i>Chọn file
                    </button>
                    <p class="text-sm text-gray-500 mt-2">Hỗ trợ: PDF, Word, Excel (Tối đa 10MB mỗi file)</p>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Danh sách file kết quả</h2>
                    <div class="flex space-x-2">
                        <input type="text" id="searchResults" placeholder="Tìm kiếm file..." class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="generateReport()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                            <i class="fas fa-chart-bar mr-2"></i>Tạo báo cáo
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Mã liên kết</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Khách hàng</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Loại mẫu</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Tên file</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Loại file</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Kích thước</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Ngày tải lên</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Trạng thái</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="resultsFilesTable" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="9" class="px-4 py-8 text-center text-gray-500">Chưa có file nào</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Customers Section -->
        <div id="customers" class="section hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Quản lý khách hàng</h2>
                    <button onclick="addNewCustomer()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Thêm khách hàng
                    </button>
                </div>
                
                <!-- Filters and Search -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div>
                        <input type="text" id="searchCustomers" placeholder="Tìm kiếm khách hàng..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onkeyup="filterCustomers()">
                    </div>
                    <div>
                        <select id="filterFrequency" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterCustomers()">
                            <option value="">Tất cả tần suất</option>
                            <option value="monthly">Hàng tháng</option>
                            <option value="quarterly">Hàng quý</option>
                            <option value="biannual">6 tháng/lần</option>
                            <option value="annual">Hàng năm</option>
                        </select>
                    </div>
                    <div>
                        <select id="filterDueStatus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterCustomers()">
                            <option value="">Tất cả trạng thái</option>
                            <option value="overdue">Quá hạn</option>
                            <option value="due-soon">Sắp đến hạn</option>
                            <option value="due-month">Trong tháng</option>
                            <option value="on-time">Còn thời gian</option>
                        </select>
                    </div>
                    <div>
                        <select id="filterYear" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterCustomers()">
                            <option value="">Tất cả năm</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-blue-600" id="totalCustomers">0</div>
                        <div class="text-sm text-gray-600">Tổng khách hàng</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-red-600" id="overdueCustomers">0</div>
                        <div class="text-sm text-gray-600">Quá hạn</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-yellow-600" id="dueSoonCustomers">0</div>
                        <div class="text-sm text-gray-600">Sắp đến hạn</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-600" id="completedSamples">0</div>
                        <div class="text-sm text-gray-600">Mẫu hoàn thành</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6" id="customersGrid">
                    <!-- Customer cards will be dynamically generated here -->
                </div>
            </div>
        </div>

        <!-- Customer Detail Modal -->
        <div id="customerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-800" id="modalCustomerName">Chi tiết khách hàng</h3>
                            <button onclick="closeCustomerModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <!-- Customer Info -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-800 mb-3">Thông tin khách hàng</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tên khách hàng</label>
                                    <input type="text" id="modalCustomerNameInput" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Số điện thoại</label>
                                    <input type="text" id="modalCustomerPhone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" id="modalCustomerEmail" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Địa chỉ</label>
                                    <input type="text" id="modalCustomerAddress" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tần suất thử nghiệm</label>
                                    <select id="modalCustomerFrequency" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="monthly">Hàng tháng (12 lần/năm)</option>
                                        <option value="quarterly">Hàng quý (4 lần/năm)</option>
                                        <option value="biannual">6 tháng/lần (2 lần/năm)</option>
                                        <option value="annual">Hàng năm (1 lần/năm)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Năm hợp đồng</label>
                                    <input type="number" id="modalContractYear" min="2020" max="2030" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>

                        <!-- Yearly Overview -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-800 mb-3">Tổng quan năm <span id="modalYearDisplay">2024</span></h4>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                                <div class="bg-blue-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-blue-600" id="modalTotalSamples">0</div>
                                    <div class="text-sm text-gray-600">Tổng số mẫu</div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-green-600" id="modalCompletedSamples">0</div>
                                    <div class="text-sm text-gray-600">Đã hoàn thành</div>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-yellow-600" id="modalRemainingSamples">0</div>
                                    <div class="text-sm text-gray-600">Còn lại</div>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-purple-600" id="modalNextDue">--</div>
                                    <div class="text-sm text-gray-600">Lần tiếp theo</div>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="mb-4">
                                <div class="flex justify-between text-sm text-gray-600 mb-2">
                                    <span>Tiến độ hoàn thành</span>
                                    <span id="modalProgressText">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div id="modalProgressBar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Linked Codes -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-800 mb-3">Mã liên kết</h4>
                            <div id="modalLinkedCodes" class="flex flex-wrap gap-2 mb-3">
                                <!-- Linked codes will be populated here -->
                            </div>
                        </div>

                        <!-- Samples History -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-semibold text-gray-800">Lịch sử mẫu thử nghiệm</h4>
                                <button onclick="addNewSample(currentCustomerId)" class="bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700 transition-colors text-sm">
                                    <i class="fas fa-plus mr-1"></i>Thêm mẫu mới
                                </button>
                            </div>
                            <div id="modalSamplesHistory" class="space-y-3 max-h-60 overflow-y-auto">
                                <!-- Samples will be populated here -->
                            </div>
                        </div>

                        <!-- Progress Tracking -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-800 mb-3">Tiến độ xử lý</h4>
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white text-sm font-bold">1</div>
                                    <span class="ml-2 text-sm font-medium">Nhận mẫu</span>
                                </div>
                                <div class="flex-1 h-1 bg-gray-200 rounded">
                                    <div class="h-1 bg-green-500 rounded" style="width: 33%"></div>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-8 h-8 rounded-full bg-yellow-500 flex items-center justify-center text-white text-sm font-bold">2</div>
                                    <span class="ml-2 text-sm font-medium">Thử nghiệm</span>
                                </div>
                                <div class="flex-1 h-1 bg-gray-200 rounded">
                                    <div class="h-1 bg-yellow-500 rounded" style="width: 66%"></div>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white text-sm font-bold">3</div>
                                    <span class="ml-2 text-sm font-medium">Trả kết quả</span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ngày nhận mẫu</label>
                                    <input type="date" id="modalReceiveDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ngày thử nghiệm</label>
                                    <input type="date" id="modalTestDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ngày trả kết quả</label>
                                    <input type="date" id="modalResultDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>

                        <!-- Sample Evaluation -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-800 mb-3">Đánh giá mẫu</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Chất lượng mẫu</label>
                                    <select id="modalSampleQuality" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Chọn đánh giá</option>
                                        <option value="excellent">Xuất sắc</option>
                                        <option value="good">Tốt</option>
                                        <option value="average">Trung bình</option>
                                        <option value="poor">Kém</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Kết quả thử nghiệm</label>
                                    <select id="modalTestResult" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Chọn kết quả</option>
                                        <option value="pass">Đạt</option>
                                        <option value="fail">Không đạt</option>
                                        <option value="conditional">Cần theo dõi</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nhận xét chi tiết</label>
                                <textarea id="modalComments" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập nhận xét về mẫu và kết quả thử nghiệm..."></textarea>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-between">
                            <div class="space-x-2">
                                <button onclick="exportCustomerProfile()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                                    <i class="fas fa-file-export mr-2"></i>Xuất hồ sơ
                                </button>
                                <button onclick="saveCustomerInfo()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-save mr-2"></i>Lưu thông tin
                                </button>
                            </div>
                            <button onclick="deleteCustomer()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                                <i class="fas fa-trash mr-2"></i>Xóa khách hàng
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification System -->
        <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2">
            <!-- Notifications will be dynamically added here -->
        </div>

        <!-- Customer Selection Modal -->
        <div id="customerSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-96 overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-800">Chọn khách hàng</h3>
                            <button onclick="closeCustomerSelectionModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="mb-4">
                            <input type="text" id="customerSearchInput" placeholder="Tìm kiếm khách hàng..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onkeyup="filterCustomerSelection()">
                        </div>
                        
                        <div class="max-h-64 overflow-y-auto" id="customerSelectionList">
                            <!-- Customer list will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Code Modal -->
        <div id="qrModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-800">Mã QR Khách hàng</h3>
                            <button onclick="closeQRModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6 text-center">
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-800 mb-2" id="qrCustomerName">Tên khách hàng</h4>
                            <p class="text-sm text-gray-600">Quét mã QR để xuất hồ sơ khách hàng</p>
                        </div>
                        
                        <div class="flex justify-center mb-4">
                            <div class="p-4 bg-white border-2 border-gray-200 rounded-lg">
                                <canvas id="qrCanvas" class="max-w-full"></canvas>
                            </div>
                        </div>
                        
                        <div class="text-xs text-gray-500 mb-4">
                            <p>Mã QR chứa link truy cập hồ sơ khách hàng</p>
                            <p>Có thể chia sẻ với khách hàng để tự xuất hồ sơ</p>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="downloadQRCode()" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                                <i class="fas fa-download mr-2"></i>Tải QR Code
                            </button>
                            <button onclick="shareQRCode()" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                                <i class="fas fa-share mr-2"></i>Chia sẻ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // File storage arrays
        let codingFiles = [];
        let analysisFiles = [];
        let resultFiles = [];
        let totalStorageUsed = 0;
        let customers = [];
        let currentCustomerId = null;





        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            document.getElementById(sectionName).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-green-700');
            });
            event.target.classList.add('active', 'bg-green-700');
        }

        function setupFileHandlers() {
            // Coding files
            setupDropZone('codingDropZone', 'codingFileInput', handleCodingFiles);
            document.getElementById('codingFileInput').addEventListener('change', handleCodingFiles);

            // Analysis files
            setupDropZone('analysisDropZone', 'analysisFileInput', handleAnalysisFiles);
            document.getElementById('analysisFileInput').addEventListener('change', handleAnalysisFiles);

            // Results files
            setupDropZone('resultsDropZone', 'resultsFileInput', handleResultFiles);
            document.getElementById('resultsFileInput').addEventListener('change', handleResultFiles);
        }

        function setupDropZone(dropZoneId, inputId, handler) {
            const dropZone = document.getElementById(dropZoneId);
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-400', 'bg-blue-50');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-400', 'bg-blue-50');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-400', 'bg-blue-50');
                
                const files = Array.from(e.dataTransfer.files);
                const input = document.getElementById(inputId);
                
                // Create a new FileList-like object
                const dt = new DataTransfer();
                files.forEach(file => dt.items.add(file));
                input.files = dt.files;
                
                handler({ target: input });
            });
        }



        function handleCodingFiles(event) {
            const fileCode = document.getElementById('codingFileCode').value.trim();
            const sampleCount = document.getElementById('sampleCount').value.trim();
            
            if (!fileCode) {
                alert('Vui lòng nhập mã file trước khi tải lên!');
                return;
            }
            
            if (fileCode.length !== 6 || !/^\d{6}$/.test(fileCode)) {
                alert('Mã file phải có định dạng DDMMYY (6 số)!');
                return;
            }
            
            if (!sampleCount || sampleCount <= 0) {
                alert('Vui lòng nhập số mẫu nhận!');
                return;
            }
            
            // Check if file code already exists
            if (codingFiles.some(f => f.fileCode === fileCode)) {
                alert('Mã file đã tồn tại! Vui lòng sử dụng mã khác.');
                return;
            }
            
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (validateFile(file, ['xls', 'xlsx', 'csv'])) {
                    const fileData = {
                        id: Date.now() + Math.random(),
                        fileCode: fileCode,
                        name: file.name,
                        type: getFileType(file.name),
                        size: file.size,
                        uploadDate: new Date(),
                        status: 'Đã tải lên',
                        codeCount: parseInt(sampleCount), // Use actual sample count
                        file: file
                    };
                    codingFiles.push(fileData);
                    totalStorageUsed += file.size;
                    addRecentUpload(file.name, 'Mã hóa');
                    
                    // Update daily sample count
                    updateDailySampleCount(parseInt(sampleCount));
                }
            });
            updateCodingTable();
            updateCodingDropdowns();
            updateDashboard();
            event.target.value = '';
            document.getElementById('codingFileCode').value = '';
            document.getElementById('sampleCount').value = '';
        }

        function handleAnalysisFiles(event) {
            const linkedCode = document.getElementById('analysisLinkedCode').value;
            
            if (!linkedCode) {
                alert('Vui lòng chọn mã file mã hóa để liên kết!');
                return;
            }
            
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (validateFile(file, ['pdf', 'doc', 'docx'])) {
                    const fileData = {
                        id: Date.now() + Math.random(),
                        linkedCode: linkedCode,
                        name: file.name,
                        type: getFileType(file.name),
                        size: file.size,
                        uploadDate: new Date(),
                        status: 'Chờ xử lý',
                        file: file
                    };
                    analysisFiles.push(fileData);
                    totalStorageUsed += file.size;
                    addRecentUpload(file.name, 'Thử nghiệm');
                }
            });
            updateAnalysisTable();
            updateDashboard();
            event.target.value = '';
            document.getElementById('analysisLinkedCode').value = '';
        }

        function handleResultFiles(event) {
            const linkedCode = document.getElementById('resultsLinkedCode').value;
            const customerName = document.getElementById('resultsCustomerName').value.trim();
            const sampleType = document.getElementById('resultsSampleType').value;
            
            if (!linkedCode) {
                alert('Vui lòng chọn mã file mã hóa để liên kết!');
                return;
            }
            
            if (!customerName) {
                alert('Vui lòng nhập tên khách hàng!');
                return;
            }
            
            if (!sampleType) {
                alert('Vui lòng chọn loại mẫu!');
                return;
            }
            
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (validateFile(file, ['pdf', 'doc', 'docx', 'xls', 'xlsx'])) {
                    const fileData = {
                        id: Date.now() + Math.random(),
                        linkedCode: linkedCode,
                        customerName: customerName,
                        sampleType: sampleType,
                        name: file.name,
                        type: getFileType(file.name),
                        size: file.size,
                        uploadDate: new Date(),
                        status: 'Đã tải lên',
                        file: file
                    };
                    resultFiles.push(fileData);
                    totalStorageUsed += file.size;
                    addRecentUpload(file.name, 'Kết quả');
                    
                    // Auto-create or update customer profile
                    updateCustomerFromResult(linkedCode, customerName, sampleType);
                }
            });
            updateResultsTable();
            updateDashboard();
            event.target.value = '';
            document.getElementById('resultsLinkedCode').value = '';
            document.getElementById('resultsCustomerName').value = '';
            document.getElementById('resultsSampleType').value = '';
        }

        function validateFile(file, allowedTypes) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (file.size > maxSize) {
                alert(`File "${file.name}" quá lớn. Kích thước tối đa là 10MB.`);
                return false;
            }
            
            if (!allowedTypes.includes(fileExtension)) {
                alert(`File "${file.name}" không được hỗ trợ. Chỉ chấp nhận: ${allowedTypes.join(', ')}`);
                return false;
            }
            
            return true;
        }

        function getFileType(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            const typeMap = {
                'pdf': 'PDF',
                'doc': 'Word',
                'docx': 'Word',
                'xls': 'Excel',
                'xlsx': 'Excel',
                'csv': 'CSV'
            };
            return typeMap[extension] || 'Unknown';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }



        function updateCodingTable() {
            const tbody = document.getElementById('codingFilesTable');
            if (codingFiles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Chưa có file nào</td></tr>';
                return;
            }
            
            tbody.innerHTML = codingFiles.map(file => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2">
                        <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 font-mono">
                            ${file.fileCode}
                        </span>
                    </td>
                    <td class="px-4 py-2">
                        <div class="flex items-center">
                            <i class="fas fa-file-${getFileIcon(file.type)} text-green-500 mr-2"></i>
                            ${file.name}
                        </div>
                    </td>
                    <td class="px-4 py-2">${file.codeCount} mã</td>
                    <td class="px-4 py-2">${formatFileSize(file.size)}</td>
                    <td class="px-4 py-2">${file.uploadDate.toLocaleDateString('vi-VN')}</td>
                    <td class="px-4 py-2">
                        <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">
                            ${file.status}
                        </span>
                    </td>
                    <td class="px-4 py-2">
                        <button onclick="viewFile(${file.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="downloadFile(${file.id})" class="text-green-600 hover:text-green-800 mr-2">
                            <i class="fas fa-download"></i>
                        </button>
                        <button onclick="deleteFile(${file.id}, 'coding')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateAnalysisTable() {
            const tbody = document.getElementById('analysisFilesTable');
            if (analysisFiles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Chưa có file nào</td></tr>';
                return;
            }
            
            tbody.innerHTML = analysisFiles.map(file => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2">
                        <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 font-mono">
                            ${file.linkedCode}
                        </span>
                    </td>
                    <td class="px-4 py-2">
                        <div class="flex items-center">
                            <i class="fas fa-file-${getFileIcon(file.type)} text-yellow-500 mr-2"></i>
                            ${file.name}
                        </div>
                    </td>
                    <td class="px-4 py-2">${file.type}</td>
                    <td class="px-4 py-2">${formatFileSize(file.size)}</td>
                    <td class="px-4 py-2">${file.uploadDate.toLocaleDateString('vi-VN')}</td>
                    <td class="px-4 py-2">
                        <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(file.status)}">
                            ${file.status}
                        </span>
                    </td>
                    <td class="px-4 py-2">
                        <button onclick="viewFile(${file.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="downloadFile(${file.id})" class="text-green-600 hover:text-green-800 mr-2">
                            <i class="fas fa-download"></i>
                        </button>
                        <button onclick="deleteFile(${file.id}, 'analysis')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateResultsTable() {
            const tbody = document.getElementById('resultsFilesTable');
            if (resultFiles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-gray-500">Chưa có file nào</td></tr>';
                return;
            }
            
            tbody.innerHTML = resultFiles.map(file => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2">
                        <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 font-mono">
                            ${file.linkedCode}
                        </span>
                    </td>
                    <td class="px-4 py-2">
                        <div class="flex items-center">
                            <i class="fas fa-user text-gray-500 mr-2"></i>
                            <button onclick="openCustomerFromResults('${file.customerName}')" class="text-blue-600 hover:text-blue-800 hover:underline">
                                ${file.customerName}
                            </button>
                        </div>
                    </td>
                    <td class="px-4 py-2">
                        <span class="px-2 py-1 text-xs rounded-full ${getSampleTypeColor(file.sampleType)}">
                            ${getSampleTypeText(file.sampleType)}
                        </span>
                    </td>
                    <td class="px-4 py-2">
                        <div class="flex items-center">
                            <i class="fas fa-file-${getFileIcon(file.type)} text-purple-500 mr-2"></i>
                            ${file.name}
                        </div>
                    </td>
                    <td class="px-4 py-2">${file.type}</td>
                    <td class="px-4 py-2">${formatFileSize(file.size)}</td>
                    <td class="px-4 py-2">${file.uploadDate.toLocaleDateString('vi-VN')}</td>
                    <td class="px-4 py-2">
                        <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">
                            ${file.status}
                        </span>
                    </td>
                    <td class="px-4 py-2">
                        <button onclick="viewFile(${file.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="downloadFile(${file.id})" class="text-green-600 hover:text-green-800 mr-2">
                            <i class="fas fa-download"></i>
                        </button>
                        <button onclick="exportCustomerProfile('${file.linkedCode}')" class="text-purple-600 hover:text-purple-800 mr-2" title="Xuất hồ sơ tổng hợp">
                            <i class="fas fa-file-export"></i>
                        </button>
                        <button onclick="deleteFile(${file.id}, 'results')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getFileIcon(type) {
            const iconMap = {
                'PDF': 'pdf',
                'Word': 'word',
                'Excel': 'excel',
                'CSV': 'csv'
            };
            return iconMap[type] || 'alt';
        }

        function getStatusColor(status) {
            switch (status) {
                case 'Chờ xử lý':
                    return 'bg-yellow-100 text-yellow-800';
                case 'Đang xử lý':
                    return 'bg-blue-100 text-blue-800';
                case 'Hoàn thành':
                case 'Đã tải lên':
                    return 'bg-green-100 text-green-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function getSampleTypeColor(sampleType) {
            switch (sampleType) {
                case 'sent':
                    return 'bg-orange-100 text-orange-800';
                case 'regular':
                    return 'bg-green-100 text-green-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function getSampleTypeText(sampleType) {
            switch (sampleType) {
                case 'sent':
                    return 'Mẫu gửi';
                case 'regular':
                    return 'Mẫu thường';
                default:
                    return 'Chưa xác định';
            }
        }

        function updateDashboard() {
            document.getElementById('codingFilesCount').textContent = codingFiles.length;
            document.getElementById('analysisFilesCount').textContent = analysisFiles.length;
            document.getElementById('resultFilesCount').textContent = resultFiles.length;
            
            const totalSizeMB = (totalStorageUsed / (1024 * 1024)).toFixed(2);
            document.getElementById('totalSize').textContent = totalSizeMB + ' MB';
            
            const storagePercentage = (totalStorageUsed / (1024 * 1024 * 1024)) * 100; // 1GB limit
            document.getElementById('storageBar').style.width = Math.min(storagePercentage, 100) + '%';
        }

        function addRecentUpload(filename, category) {
            const container = document.getElementById('recentUploads');
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            
            const uploadElement = document.createElement('div');
            uploadElement.className = 'flex items-center space-x-3 p-3 bg-gray-50 rounded-lg';
            uploadElement.innerHTML = `
                <i class="fas fa-file-upload text-green-500"></i>
                <div class="flex-1">
                    <p class="text-sm text-gray-800">${filename}</p>
                    <p class="text-xs text-gray-500">${category} • ${timeString}</p>
                </div>
            `;
            
            if (container.querySelector('.text-gray-500')) {
                container.innerHTML = '';
            }
            
            container.insertBefore(uploadElement, container.firstChild);
            
            while (container.children.length > 5) {
                container.removeChild(container.lastChild);
            }
        }

        function viewFile(fileId) {
            alert('Chức năng xem trước file sẽ được phát triển trong phiên bản tiếp theo.');
        }

        function downloadFile(fileId) {
            alert('File sẽ được tải xuống (chức năng demo).');
        }

        function deleteFile(fileId, category) {
            if (confirm('Bạn có chắc chắn muốn xóa file này?')) {
                let fileArray;
                switch (category) {
                    case 'coding':
                        fileArray = codingFiles;
                        break;
                    case 'analysis':
                        fileArray = analysisFiles;
                        break;
                    case 'results':
                        fileArray = resultFiles;
                        break;
                }
                
                const fileIndex = fileArray.findIndex(f => f.id === fileId);
                if (fileIndex > -1) {
                    totalStorageUsed -= fileArray[fileIndex].size;
                    fileArray.splice(fileIndex, 1);
                    
                    switch (category) {
                        case 'coding':
                            updateCodingTable();
                            break;
                        case 'analysis':
                            updateAnalysisTable();
                            break;
                        case 'results':
                            updateResultsTable();
                            break;
                    }
                    
                    updateDashboard();
                    alert('File đã được xóa thành công!');
                }
            }
        }

        function exportCodingData() {
            alert('Dữ liệu mã hóa sẽ được xuất ra file Excel.\n\nChức năng này sẽ tổng hợp tất cả các mã từ các file đã tải lên.');
        }

        function generateReport() {
            alert('Báo cáo tổng hợp kết quả thử nghiệm sẽ được tạo.\n\nBáo cáo sẽ bao gồm thống kê và phân tích từ tất cả các file kết quả.');
        }

        // Customer management functions
        function loadSampleCustomers() {
            customers = [
                {
                    id: 1,
                    name: 'Công ty TNHH ABC',
                    phone: '0123456789',
                    email: 'contact@abc.com',
                    address: '123 Đường ABC, Quận 1, TP.HCM',
                    frequency: 'quarterly', // 4 lần/năm
                    contractYear: '2024',
                    totalSamplesPerYear: 4,
                    completedSamples: 1,
                    nextDueDate: '2024-04-15',
                    linkedCodes: ['250124', '150324'],
                    samples: [
                        {
                            quarter: 'Q1-2024',
                            linkedCode: '250124',
                            receiveDate: '2024-01-25',
                            testDate: '2024-01-28',
                            resultDate: '2024-02-01',
                            sampleQuality: 'good',
                            testResult: 'pass',
                            comments: 'Mẫu đạt chất lượng tốt, kết quả thử nghiệm trong giới hạn cho phép.',
                            status: 'completed'
                        }
                    ],
                    status: 'active',
                    createdFrom: 'manual',
                    firstReceiveDate: '2024-01-25'
                },
                {
                    id: 2,
                    name: 'Công ty XYZ Ltd',
                    phone: '0987654321',
                    email: 'info@xyz.com',
                    address: '456 Đường XYZ, Quận 3, TP.HCM',
                    frequency: 'annual', // 1 lần/năm
                    contractYear: '2024',
                    totalSamplesPerYear: 1,
                    completedSamples: 0,
                    nextDueDate: '2024-06-30',
                    linkedCodes: ['200124'],
                    samples: [
                        {
                            quarter: 'Annual-2024',
                            linkedCode: '200124',
                            receiveDate: '2024-01-20',
                            testDate: '2024-01-23',
                            resultDate: '',
                            sampleQuality: 'excellent',
                            testResult: '',
                            comments: 'Mẫu chất lượng xuất sắc, đang trong quá trình thử nghiệm.',
                            status: 'testing'
                        }
                    ],
                    status: 'active',
                    createdFrom: 'manual',
                    firstReceiveDate: '2024-01-20'
                },
                {
                    id: 3,
                    name: 'Doanh nghiệp DEF',
                    phone: '0369852147',
                    email: 'support@def.vn',
                    address: '789 Đường DEF, Quận 7, TP.HCM',
                    frequency: 'biannual', // 2 lần/năm
                    contractYear: '2024',
                    totalSamplesPerYear: 2,
                    completedSamples: 0,
                    nextDueDate: '2024-03-01',
                    linkedCodes: ['250124'],
                    samples: [
                        {
                            quarter: 'H1-2024',
                            linkedCode: '250124',
                            receiveDate: '2024-01-25',
                            testDate: '',
                            resultDate: '',
                            sampleQuality: '',
                            testResult: '',
                            comments: '',
                            status: 'received'
                        }
                    ],
                    status: 'active',
                    createdFrom: 'manual',
                    firstReceiveDate: '2024-01-25'
                },
                {
                    id: 4,
                    name: 'Tập đoàn GHI',
                    phone: '0147258369',
                    email: 'lab@ghi.com',
                    address: '321 Đường GHI, Quận 5, TP.HCM',
                    frequency: 'monthly', // 12 lần/năm
                    contractYear: '2024',
                    totalSamplesPerYear: 12,
                    completedSamples: 2,
                    nextDueDate: '2024-03-01',
                    linkedCodes: ['050124', '030224'],
                    samples: [
                        {
                            quarter: 'Jan-2024',
                            linkedCode: '050124',
                            receiveDate: '2024-01-05',
                            testDate: '2024-01-08',
                            resultDate: '2024-01-12',
                            sampleQuality: 'excellent',
                            testResult: 'pass',
                            comments: 'Mẫu đạt tiêu chuẩn cao.',
                            status: 'completed'
                        },
                        {
                            quarter: 'Feb-2024',
                            linkedCode: '030224',
                            receiveDate: '2024-02-03',
                            testDate: '2024-02-06',
                            resultDate: '2024-02-10',
                            sampleQuality: 'good',
                            testResult: 'pass',
                            comments: 'Kết quả ổn định.',
                            status: 'completed'
                        }
                    ],
                    status: 'active',
                    createdFrom: 'manual',
                    firstReceiveDate: '2024-01-05'
                }
            ];
        }

        function updateCustomersGrid() {
            const grid = document.getElementById('customersGrid');
            if (customers.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Chưa có khách hàng nào</div>';
                return;
            }

            grid.innerHTML = customers.map(customer => {
                const frequencyInfo = getFrequencyInfo(customer.frequency);
                const progressInfo = getYearlyProgress(customer);
                const dueDateStatus = getDueDateStatus(customer.nextDueDate);
                
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow ${dueDateStatus.urgent ? 'border-red-300 bg-red-50' : ''}">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-semibold text-gray-800 text-lg">${customer.name}</h3>
                                <p class="text-sm text-gray-600">${customer.phone}</p>
                                <p class="text-sm text-gray-600">${customer.email}</p>
                            </div>
                            <div class="text-right">
                                <span class="px-2 py-1 text-xs rounded-full ${frequencyInfo.color} block mb-1">
                                    ${frequencyInfo.text}
                                </span>
                                <span class="px-2 py-1 text-xs rounded-full ${dueDateStatus.color}">
                                    ${dueDateStatus.text}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Yearly Progress -->
                        <div class="mb-4">
                            <div class="flex justify-between text-sm text-gray-600 mb-2">
                                <span>Tiến độ năm ${customer.contractYear}</span>
                                <span>${customer.completedSamples}/${customer.totalSamplesPerYear}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${progressInfo.percentage}%"></div>
                            </div>
                        </div>
                        
                        <!-- Schedule Info -->
                        <div class="text-sm text-gray-600 mb-4 bg-gray-50 p-3 rounded-lg">
                            <div class="flex justify-between mb-1">
                                <span>Tần suất:</span>
                                <span class="font-medium">${frequencyInfo.description}</span>
                            </div>
                            <div class="flex justify-between mb-1">
                                <span>Lần tiếp theo:</span>
                                <span class="font-medium ${dueDateStatus.urgent ? 'text-red-600' : 'text-blue-600'}">${formatDate(customer.nextDueDate)}</span>
                            </div>
                            <div class="flex justify-between mb-1">
                                <span>Còn lại trong năm:</span>
                                <span class="font-medium">${customer.totalSamplesPerYear - customer.completedSamples} mẫu</span>
                            </div>
                            ${customer.linkedCodes && customer.linkedCodes.length > 0 ? `
                            <div class="flex justify-between">
                                <span>Mã liên kết:</span>
                                <span class="font-medium text-blue-600">${customer.linkedCodes.length} mã</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <!-- Latest Sample Status -->
                        ${customer.samples && customer.samples.length > 0 ? `
                        <div class="text-sm text-gray-600 mb-4 border-t pt-3">
                            <div class="font-medium mb-2">Mẫu gần nhất (${customer.samples[customer.samples.length - 1].quarter}):</div>
                            <div class="flex justify-between">
                                <span>Trạng thái:</span>
                                <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(customer.samples[customer.samples.length - 1].status)}">
                                    ${getStatusText(customer.samples[customer.samples.length - 1].status)}
                                </span>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="flex space-x-2">
                            <button onclick="openCustomerModal(${customer.id})" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700 transition-colors text-sm">
                                <i class="fas fa-edit mr-1"></i>Chi tiết
                            </button>
                            <button onclick="addNewSample(${customer.id})" class="bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700 transition-colors text-sm" title="Thêm mẫu mới">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="showQRCode(${customer.id})" class="bg-purple-600 text-white px-3 py-2 rounded-md hover:bg-purple-700 transition-colors text-sm" title="Tạo mã QR">
                                <i class="fas fa-qrcode"></i>
                            </button>
                            <button onclick="exportCustomerProfile(${customer.id})" class="bg-orange-600 text-white px-3 py-2 rounded-md hover:bg-orange-700 transition-colors text-sm">
                                <i class="fas fa-file-export"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getFrequencyInfo(frequency) {
            switch (frequency) {
                case 'monthly':
                    return { 
                        text: 'Hàng tháng', 
                        description: '12 lần/năm',
                        color: 'bg-red-100 text-red-800' 
                    };
                case 'quarterly':
                    return { 
                        text: 'Hàng quý', 
                        description: '4 lần/năm',
                        color: 'bg-blue-100 text-blue-800' 
                    };
                case 'biannual':
                    return { 
                        text: '6 tháng/lần', 
                        description: '2 lần/năm',
                        color: 'bg-green-100 text-green-800' 
                    };
                case 'annual':
                    return { 
                        text: 'Hàng năm', 
                        description: '1 lần/năm',
                        color: 'bg-purple-100 text-purple-800' 
                    };
                default:
                    return { 
                        text: 'Chưa xác định', 
                        description: 'Chưa xác định',
                        color: 'bg-gray-100 text-gray-800' 
                    };
            }
        }

        function getYearlyProgress(customer) {
            const percentage = (customer.completedSamples / customer.totalSamplesPerYear) * 100;
            return {
                percentage: Math.round(percentage),
                completed: customer.completedSamples,
                total: customer.totalSamplesPerYear,
                remaining: customer.totalSamplesPerYear - customer.completedSamples
            };
        }

        function getDueDateStatus(nextDueDate) {
            if (!nextDueDate) {
                return { text: 'Chưa xác định', color: 'bg-gray-100 text-gray-800', urgent: false };
            }
            
            const today = new Date();
            const dueDate = new Date(nextDueDate);
            const diffTime = dueDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return { text: 'Quá hạn', color: 'bg-red-100 text-red-800', urgent: true };
            } else if (diffDays <= 7) {
                return { text: 'Sắp đến hạn', color: 'bg-orange-100 text-orange-800', urgent: true };
            } else if (diffDays <= 30) {
                return { text: 'Trong tháng', color: 'bg-yellow-100 text-yellow-800', urgent: false };
            } else {
                return { text: 'Còn thời gian', color: 'bg-green-100 text-green-800', urgent: false };
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'received':
                    return 'Đã nhận mẫu';
                case 'testing':
                    return 'Đang thử nghiệm';
                case 'completed':
                    return 'Hoàn thành';
                default:
                    return 'Chưa xác định';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'Chưa có';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        function addNewCustomer() {
            const newCustomer = {
                id: Date.now(),
                name: 'Khách hàng mới',
                phone: '',
                email: '',
                address: '',
                frequency: 'quarterly',
                contractYear: new Date().getFullYear().toString(),
                totalSamplesPerYear: 4,
                completedSamples: 0,
                nextDueDate: '',
                samples: [],
                status: 'active'
            };
            
            customers.push(newCustomer);
            updateCustomersGrid();
            openCustomerModal(newCustomer.id);
        }

        function addNewSample(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            const samplePeriod = generateSamplePeriod(customer);
            const newSample = {
                quarter: samplePeriod,
                receiveDate: '',
                testDate: '',
                resultDate: '',
                sampleQuality: '',
                testResult: '',
                comments: '',
                status: 'received'
            };
            
            customer.samples.push(newSample);
            updateNextDueDate(customer);
            
            if (currentCustomerId === customerId) {
                updateModalSamplesHistory(customer);
                updateModalOverview(customer);
            }
            
            updateCustomersGrid();
            alert(`Đã thêm mẫu mới cho kỳ ${samplePeriod}`);
        }

        function generateSamplePeriod(customer) {
            const year = customer.contractYear;
            const existingSamples = customer.samples.length;
            
            switch (customer.frequency) {
                case 'monthly':
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    return `${months[existingSamples % 12]}-${year}`;
                case 'quarterly':
                    return `Q${(existingSamples % 4) + 1}-${year}`;
                case 'biannual':
                    return `H${(existingSamples % 2) + 1}-${year}`;
                case 'annual':
                    return `Annual-${year}`;
                default:
                    return `Sample-${existingSamples + 1}-${year}`;
            }
        }

        function updateNextDueDate(customer) {
            const today = new Date();
            let nextDate = new Date(today);
            
            switch (customer.frequency) {
                case 'monthly':
                    nextDate.setMonth(today.getMonth() + 1);
                    break;
                case 'quarterly':
                    nextDate.setMonth(today.getMonth() + 3);
                    break;
                case 'biannual':
                    nextDate.setMonth(today.getMonth() + 6);
                    break;
                case 'annual':
                    nextDate.setFullYear(today.getFullYear() + 1);
                    break;
            }
            
            customer.nextDueDate = nextDate.toISOString().split('T')[0];
        }

        function updateTotalSamplesPerYear(customer) {
            switch (customer.frequency) {
                case 'monthly':
                    customer.totalSamplesPerYear = 12;
                    break;
                case 'quarterly':
                    customer.totalSamplesPerYear = 4;
                    break;
                case 'biannual':
                    customer.totalSamplesPerYear = 2;
                    break;
                case 'annual':
                    customer.totalSamplesPerYear = 1;
                    break;
                default:
                    customer.totalSamplesPerYear = 1;
            }
        }

        function openCustomerModal(customerId) {
            currentCustomerId = customerId;
            const customer = customers.find(c => c.id === customerId);
            
            if (!customer) return;
            
            // Fill modal with customer data
            document.getElementById('modalCustomerName').textContent = customer.name;
            document.getElementById('modalCustomerNameInput').value = customer.name;
            document.getElementById('modalCustomerPhone').value = customer.phone || '';
            document.getElementById('modalCustomerEmail').value = customer.email || '';
            document.getElementById('modalCustomerAddress').value = customer.address || '';
            document.getElementById('modalCustomerFrequency').value = customer.frequency || 'quarterly';
            document.getElementById('modalContractYear').value = customer.contractYear || new Date().getFullYear();
            
            // Update linked codes display
            updateModalLinkedCodes(customer);
            
            // Update modal overview
            updateModalOverview(customer);
            
            // Update samples history
            updateModalSamplesHistory(customer);
            
            document.getElementById('customerModal').classList.remove('hidden');
        }

        function updateModalOverview(customer) {
            const completedSamples = customer.samples.filter(s => s.status === 'completed').length;
            const remainingSamples = customer.totalSamplesPerYear - completedSamples;
            const progressPercentage = (completedSamples / customer.totalSamplesPerYear) * 100;
            
            document.getElementById('modalYearDisplay').textContent = customer.contractYear;
            document.getElementById('modalTotalSamples').textContent = customer.totalSamplesPerYear;
            document.getElementById('modalCompletedSamples').textContent = completedSamples;
            document.getElementById('modalRemainingSamples').textContent = remainingSamples;
            document.getElementById('modalNextDue').textContent = formatDate(customer.nextDueDate);
            document.getElementById('modalProgressText').textContent = Math.round(progressPercentage) + '%';
            document.getElementById('modalProgressBar').style.width = progressPercentage + '%';
        }

        function updateModalSamplesHistory(customer) {
            const container = document.getElementById('modalSamplesHistory');
            
            if (!customer.samples || customer.samples.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">Chưa có mẫu nào</div>';
                return;
            }
            
            container.innerHTML = customer.samples.map((sample, index) => `
                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h5 class="font-medium text-gray-800">${sample.quarter}</h5>
                            <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(sample.status)}">
                                ${getStatusText(sample.status)}
                            </span>
                        </div>
                        <button onclick="deleteSample(${customer.id}, ${index})" class="text-red-600 hover:text-red-800 text-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Ngày nhận mẫu</label>
                            <input type="date" value="${sample.receiveDate}" onchange="updateSampleField(${customer.id}, ${index}, 'receiveDate', this.value)" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Ngày thử nghiệm</label>
                            <input type="date" value="${sample.testDate}" onchange="updateSampleField(${customer.id}, ${index}, 'testDate', this.value)" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Ngày trả kết quả</label>
                            <input type="date" value="${sample.resultDate}" onchange="updateSampleField(${customer.id}, ${index}, 'resultDate', this.value)" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Chất lượng mẫu</label>
                            <select value="${sample.sampleQuality}" onchange="updateSampleField(${customer.id}, ${index}, 'sampleQuality', this.value)" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <option value="">Chọn đánh giá</option>
                                <option value="excellent" ${sample.sampleQuality === 'excellent' ? 'selected' : ''}>Xuất sắc</option>
                                <option value="good" ${sample.sampleQuality === 'good' ? 'selected' : ''}>Tốt</option>
                                <option value="average" ${sample.sampleQuality === 'average' ? 'selected' : ''}>Trung bình</option>
                                <option value="poor" ${sample.sampleQuality === 'poor' ? 'selected' : ''}>Kém</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Kết quả thử nghiệm</label>
                            <select value="${sample.testResult}" onchange="updateSampleField(${customer.id}, ${index}, 'testResult', this.value)" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <option value="">Chọn kết quả</option>
                                <option value="pass" ${sample.testResult === 'pass' ? 'selected' : ''}>Đạt</option>
                                <option value="fail" ${sample.testResult === 'fail' ? 'selected' : ''}>Không đạt</option>
                                <option value="conditional" ${sample.testResult === 'conditional' ? 'selected' : ''}>Cần theo dõi</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Nhận xét</label>
                        <textarea rows="2" placeholder="Nhập nhận xét..." onchange="updateSampleField(${customer.id}, ${index}, 'comments', this.value)" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">${sample.comments}</textarea>
                    </div>
                </div>
            `).join('');
        }

        function updateSampleField(customerId, sampleIndex, field, value) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer || !customer.samples[sampleIndex]) return;
            
            customer.samples[sampleIndex][field] = value;
            
            // Auto-update status based on progress
            const sample = customer.samples[sampleIndex];
            if (sample.resultDate) {
                sample.status = 'completed';
            } else if (sample.testDate) {
                sample.status = 'testing';
            } else if (sample.receiveDate) {
                sample.status = 'received';
            }
            
            // Update completed samples count
            customer.completedSamples = customer.samples.filter(s => s.status === 'completed').length;
            
            // Refresh displays
            updateModalOverview(customer);
            updateCustomersGrid();
        }

        function deleteSample(customerId, sampleIndex) {
            if (!confirm('Bạn có chắc chắn muốn xóa mẫu này?')) return;
            
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            customer.samples.splice(sampleIndex, 1);
            customer.completedSamples = customer.samples.filter(s => s.status === 'completed').length;
            
            updateModalSamplesHistory(customer);
            updateModalOverview(customer);
            updateCustomersGrid();
        }

        function closeCustomerModal() {
            document.getElementById('customerModal').classList.add('hidden');
            currentCustomerId = null;
        }

        function saveCustomerInfo() {
            if (!currentCustomerId) return;
            
            const customer = customers.find(c => c.id === currentCustomerId);
            if (!customer) return;
            
            // Update customer data
            customer.name = document.getElementById('modalCustomerNameInput').value;
            customer.phone = document.getElementById('modalCustomerPhone').value;
            customer.email = document.getElementById('modalCustomerEmail').value;
            customer.address = document.getElementById('modalCustomerAddress').value;
            customer.frequency = document.getElementById('modalCustomerFrequency').value;
            customer.contractYear = document.getElementById('modalContractYear').value;
            
            // Update total samples per year based on frequency
            updateTotalSamplesPerYear(customer);
            
            // Update next due date
            updateNextDueDate(customer);
            
            // Update modal title
            document.getElementById('modalCustomerName').textContent = customer.name;
            
            // Refresh displays
            updateModalOverview(customer);
            updateCustomersGrid();
            
            alert('Thông tin khách hàng đã được lưu thành công!');
        }

        function deleteCustomer() {
            if (!currentCustomerId) return;
            
            if (confirm('Bạn có chắc chắn muốn xóa khách hàng này?')) {
                customers = customers.filter(c => c.id !== currentCustomerId);
                updateCustomersGrid();
                closeCustomerModal();
                alert('Khách hàng đã được xóa thành công!');
            }
        }

        // Generate file code for today
        function generateFileCode() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = String(today.getFullYear()).slice(-2);
            const code = day + month + year;
            document.getElementById('codingFileCode').value = code;
        }

        // Update dropdown options for linking files
        function updateCodingDropdowns() {
            const analysisSelect = document.getElementById('analysisLinkedCode');
            const resultsSelect = document.getElementById('resultsLinkedCode');
            
            const options = codingFiles.map(file => 
                `<option value="${file.fileCode}">${file.fileCode} - ${file.name}</option>`
            ).join('');
            
            analysisSelect.innerHTML = '<option value="">Chọn mã file mã hóa</option>' + options;
            resultsSelect.innerHTML = '<option value="">Chọn mã file mã hóa</option>' + options;
        }

        // Customer selection functions
        function selectFromCustomerList() {
            populateCustomerSelectionList();
            document.getElementById('customerSelectionModal').classList.remove('hidden');
        }

        function populateCustomerSelectionList() {
            const list = document.getElementById('customerSelectionList');
            
            if (customers.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-4">Chưa có khách hàng nào</div>';
                return;
            }
            
            list.innerHTML = customers.map(customer => `
                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg mb-2 hover:bg-gray-50 cursor-pointer" onclick="selectCustomer('${customer.name}')">
                    <div>
                        <div class="font-medium text-gray-800">${customer.name}</div>
                        <div class="text-sm text-gray-600">${customer.phone || 'Chưa có SĐT'} • ${customer.email || 'Chưa có email'}</div>
                        <div class="text-xs text-gray-500">${getFrequencyInfo(customer.frequency).description}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium text-blue-600">${customer.completedSamples}/${customer.totalSamplesPerYear}</div>
                        <div class="text-xs text-gray-500">mẫu hoàn thành</div>
                    </div>
                </div>
            `).join('');
        }

        function filterCustomerSelection() {
            const searchTerm = document.getElementById('customerSearchInput').value.toLowerCase();
            const filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm) ||
                customer.phone.includes(searchTerm) ||
                customer.email.toLowerCase().includes(searchTerm)
            );
            
            const list = document.getElementById('customerSelectionList');
            
            if (filteredCustomers.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-4">Không tìm thấy khách hàng nào</div>';
                return;
            }
            
            list.innerHTML = filteredCustomers.map(customer => `
                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg mb-2 hover:bg-gray-50 cursor-pointer" onclick="selectCustomer('${customer.name}')">
                    <div>
                        <div class="font-medium text-gray-800">${customer.name}</div>
                        <div class="text-sm text-gray-600">${customer.phone || 'Chưa có SĐT'} • ${customer.email || 'Chưa có email'}</div>
                        <div class="text-xs text-gray-500">${getFrequencyInfo(customer.frequency).description}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium text-blue-600">${customer.completedSamples}/${customer.totalSamplesPerYear}</div>
                        <div class="text-xs text-gray-500">mẫu hoàn thành</div>
                    </div>
                </div>
            `).join('');
        }

        function selectCustomer(customerName) {
            document.getElementById('resultsCustomerName').value = customerName;
            closeCustomerSelectionModal();
        }

        function closeCustomerSelectionModal() {
            document.getElementById('customerSelectionModal').classList.add('hidden');
            document.getElementById('customerSearchInput').value = '';
        }

        function openCustomerFromResults(customerName) {
            const customer = customers.find(c => c.name === customerName);
            if (customer) {
                // Switch to customers tab
                showSection('customers');
                // Open customer modal
                setTimeout(() => {
                    openCustomerModal(customer.id);
                }, 100);
            } else {
                alert(`Không tìm thấy thông tin chi tiết cho khách hàng: ${customerName}\n\nKhách hàng này có thể được tạo tự động từ file kết quả.`);
            }
        }

        // Update customer from result file
        function updateCustomerFromResult(linkedCode, customerName, sampleType) {
            let customer = customers.find(c => c.name === customerName);
            
            if (!customer) {
                // Create new customer
                customer = {
                    id: Date.now(),
                    name: customerName,
                    phone: '',
                    email: '',
                    address: '',
                    frequency: 'quarterly',
                    contractYear: new Date().getFullYear().toString(),
                    totalSamplesPerYear: 4,
                    completedSamples: 1,
                    nextDueDate: '',
                    linkedCodes: [linkedCode],
                    samples: [{
                        quarter: 'Auto-' + new Date().getFullYear(),
                        linkedCode: linkedCode,
                        receiveDate: new Date().toISOString().split('T')[0],
                        testDate: '',
                        resultDate: new Date().toISOString().split('T')[0],
                        sampleQuality: '',
                        testResult: '',
                        comments: `Tự động tạo từ file kết quả - Loại mẫu: ${getSampleTypeText(sampleType)}`,
                        status: 'completed',
                        sampleType: sampleType
                    }],
                    status: 'active',
                    createdFrom: 'result-file',
                    firstReceiveDate: new Date().toISOString().split('T')[0]
                };
                customers.push(customer);
                updateNextDueDate(customer);
            } else {
                // Update existing customer
                if (!customer.linkedCodes) customer.linkedCodes = [];
                if (!customer.linkedCodes.includes(linkedCode)) {
                    customer.linkedCodes.push(linkedCode);
                }
                
                // Add new sample
                const newSample = {
                    quarter: 'Sample-' + (customer.samples.length + 1) + '-' + customer.contractYear,
                    linkedCode: linkedCode,
                    receiveDate: new Date().toISOString().split('T')[0],
                    testDate: '',
                    resultDate: new Date().toISOString().split('T')[0],
                    sampleQuality: '',
                    testResult: '',
                    comments: `Loại mẫu: ${getSampleTypeText(sampleType)}`,
                    status: 'completed',
                    sampleType: sampleType
                };
                
                if (!customer.samples) customer.samples = [];
                customer.samples.push(newSample);
                customer.completedSamples = customer.samples.filter(s => s.status === 'completed').length;
            }
            
            updateCustomersGrid();
            updateCustomerStats();
        }

        function exportCustomerProfile(linkedCode = null) {
            let customer, codingFile, analysisFile, resultFile;
            
            if (linkedCode) {
                // Export by linked code (from results table)
                customer = customers.find(c => c.linkedCode === linkedCode);
                codingFile = codingFiles.find(f => f.fileCode === linkedCode);
                analysisFile = analysisFiles.find(f => f.linkedCode === linkedCode);
                resultFile = resultFiles.find(f => f.linkedCode === linkedCode);
                
                if (!customer && resultFile) {
                    customer = { name: resultFile.customerName, linkedCode: linkedCode };
                }
            } else {
                // Export by customer ID (from customer modal)
                const id = currentCustomerId;
                if (!id) return;
                
                customer = customers.find(c => c.id === id);
                if (!customer) return;
                
                codingFile = codingFiles.find(f => f.fileCode === customer.linkedCode);
                analysisFile = analysisFiles.find(f => f.linkedCode === customer.linkedCode);
                resultFile = resultFiles.find(f => f.linkedCode === customer.linkedCode);
            }
            
            if (!customer) {
                alert('Không tìm thấy thông tin khách hàng!');
                return;
            }
            
            // Generate comprehensive profile
            let profileContent = `HỒ SƠ TỔNG HỢP KHÁCH HÀNG\n`;
            profileContent += `=====================================\n\n`;
            
            profileContent += `THÔNG TIN KHÁCH HÀNG:\n`;
            profileContent += `- Tên: ${customer.name}\n`;
            profileContent += `- Điện thoại: ${customer.phone || 'Chưa có'}\n`;
            profileContent += `- Email: ${customer.email || 'Chưa có'}\n`;
            profileContent += `- Địa chỉ: ${customer.address || 'Chưa có'}\n`;
            profileContent += `- Mã liên kết: ${customer.linkedCode || linkedCode}\n\n`;
            
            if (codingFile) {
                profileContent += `FILE MÃ HÓA:\n`;
                profileContent += `- Mã file: ${codingFile.fileCode}\n`;
                profileContent += `- Tên file: ${codingFile.name}\n`;
                profileContent += `- Số lượng mã: ${codingFile.codeCount}\n`;
                profileContent += `- Ngày tải lên: ${codingFile.uploadDate.toLocaleDateString('vi-VN')}\n\n`;
            }
            
            if (analysisFile) {
                profileContent += `FILE THỬ NGHIỆM:\n`;
                profileContent += `- Tên file: ${analysisFile.name}\n`;
                profileContent += `- Loại file: ${analysisFile.type}\n`;
                profileContent += `- Ngày tải lên: ${analysisFile.uploadDate.toLocaleDateString('vi-VN')}\n`;
                profileContent += `- Trạng thái: ${analysisFile.status}\n\n`;
            }
            
            if (resultFile) {
                profileContent += `FILE KẾT QUẢ:\n`;
                profileContent += `- Tên file: ${resultFile.name}\n`;
                profileContent += `- Loại file: ${resultFile.type}\n`;
                profileContent += `- Loại mẫu: ${getSampleTypeText(resultFile.sampleType)}\n`;
                profileContent += `- Ngày tải lên: ${resultFile.uploadDate.toLocaleDateString('vi-VN')}\n`;
                profileContent += `- Trạng thái: ${resultFile.status}\n\n`;
            }
            
            profileContent += `TIẾN ĐỘ XỬ LÝ:\n`;
            profileContent += `- Ngày nhận mẫu: ${customer.receiveDate || 'Chưa có'}\n`;
            profileContent += `- Ngày thử nghiệm: ${customer.testDate || 'Chưa có'}\n`;
            profileContent += `- Ngày trả kết quả: ${customer.resultDate || 'Chưa có'}\n\n`;
            
            if (customer.sampleQuality || customer.testResult || customer.comments) {
                profileContent += `ĐÁNH GIÁ:\n`;
                profileContent += `- Chất lượng mẫu: ${customer.sampleQuality || 'Chưa đánh giá'}\n`;
                profileContent += `- Kết quả thử nghiệm: ${customer.testResult || 'Chưa có'}\n`;
                profileContent += `- Nhận xét: ${customer.comments || 'Chưa có'}\n\n`;
            }
            
            profileContent += `Hồ sơ được tạo tự động bởi hệ thống LAB-CEMHUE\n`;
            profileContent += `Thời gian xuất: ${new Date().toLocaleString('vi-VN')}`;
            
            alert(`Đang xuất hồ sơ tổng hợp cho: ${customer.name}\n\nHồ sơ bao gồm:\n${codingFile ? '✓ File mã hóa\n' : '✗ File mã hóa\n'}${analysisFile ? '✓ File thử nghiệm\n' : '✗ File thử nghiệm\n'}${resultFile ? '✓ File kết quả\n' : '✗ File kết quả\n'}\nFile PDF sẽ được tải về máy tính của bạn.`);
        }

        // QR Code functions
        function showQRCode(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            // Set customer name in modal
            document.getElementById('qrCustomerName').textContent = customer.name;
            
            // Generate QR code data (URL to customer profile)
            const baseUrl = window.location.origin + window.location.pathname;
            const qrData = `${baseUrl}?customer=${customerId}&action=export`;
            
            // Generate QR code
            const canvas = document.getElementById('qrCanvas');
            QRCode.toCanvas(canvas, qrData, {
                width: 200,
                height: 200,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                },
                errorCorrectionLevel: 'M'
            }, function (error) {
                if (error) {
                    console.error('QR Code generation error:', error);
                    alert('Có lỗi khi tạo mã QR. Vui lòng thử lại.');
                    return;
                }
                
                // Show modal
                document.getElementById('qrModal').classList.remove('hidden');
            });
        }

        function closeQRModal() {
            document.getElementById('qrModal').classList.add('hidden');
        }

        function downloadQRCode() {
            const canvas = document.getElementById('qrCanvas');
            const customerName = document.getElementById('qrCustomerName').textContent;
            
            // Create download link
            const link = document.createElement('a');
            link.download = `QR_${customerName.replace(/[^a-zA-Z0-9]/g, '_')}.png`;
            link.href = canvas.toDataURL();
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Mã QR đã được tải xuống thành công!');
        }

        function shareQRCode() {
            const canvas = document.getElementById('qrCanvas');
            const customerName = document.getElementById('qrCustomerName').textContent;
            
            // Convert canvas to blob
            canvas.toBlob(function(blob) {
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([blob], 'qr-code.png', { type: 'image/png' })] })) {
                    // Use Web Share API if available
                    const file = new File([blob], `QR_${customerName}.png`, { type: 'image/png' });
                    navigator.share({
                        title: `Mã QR - ${customerName}`,
                        text: `Mã QR để xuất hồ sơ khách hàng: ${customerName}`,
                        files: [file]
                    }).catch(err => {
                        console.log('Share cancelled or failed:', err);
                    });
                } else {
                    // Fallback: Copy link to clipboard
                    const baseUrl = window.location.origin + window.location.pathname;
                    const customerId = customers.find(c => c.name === customerName)?.id;
                    const shareUrl = `${baseUrl}?customer=${customerId}&action=export`;
                    
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        alert('Link đã được sao chép vào clipboard!\n\nBạn có thể chia sẻ link này với khách hàng để họ tự xuất hồ sơ.');
                    }).catch(() => {
                        alert(`Link chia sẻ:\n${shareUrl}\n\nVui lòng sao chép link này để chia sẻ.`);
                    });
                }
            }, 'image/png');
        }

        // Handle QR code scanning result
        function handleQRScan() {
            const urlParams = new URLSearchParams(window.location.search);
            const customerId = urlParams.get('customer');
            const action = urlParams.get('action');
            
            if (customerId && action === 'export') {
                // Auto-export customer profile when accessed via QR code
                setTimeout(() => {
                    exportCustomerProfile(parseInt(customerId));
                    // Show customer section
                    showSection('customers');
                    // Highlight the customer
                    const customer = customers.find(c => c.id === parseInt(customerId));
                    if (customer) {
                        alert(`Chào mừng! Bạn đang truy cập hồ sơ của: ${customer.name}\n\nHồ sơ sẽ được xuất tự động.`);
                    }
                }, 1000);
            }
        }

        // Login functionality
        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('userRole').value;
            
            if (!username || !password || !role) {
                alert('Vui lòng điền đầy đủ thông tin đăng nhập!');
                return;
            }
            
            // Simple demo authentication
            const validCredentials = {
                'admin': { password: 'admin123', name: 'BANISO Admin' },
                'director': { password: 'director123', name: 'Giám đốc' },
                'lab': { password: 'lab123', name: 'Phòng thí nghiệm' }
            };
            
            if (validCredentials[role] && validCredentials[role].password === password) {
                // Store user session
                sessionStorage.setItem('userRole', role);
                sessionStorage.setItem('userName', validCredentials[role].name);
                
                // Update UI based on role
                updateUIForRole(role);
                
                alert(`Đăng nhập thành công!\nChào mừng ${validCredentials[role].name}`);
                
                // Clear login form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('userRole').value = '';
            } else {
                alert('Thông tin đăng nhập không chính xác!');
            }
        }
        
        function updateUIForRole(role) {
            const navButtons = document.querySelectorAll('.nav-btn');
            
            // Reset all buttons to visible
            navButtons.forEach(btn => {
                btn.style.display = 'block';
            });
            
            // Apply role-based restrictions
            switch(role) {
                case 'admin':
                    // BANISO has full access - no restrictions
                    break;
                case 'director':
                    // Director can view everything but with read-only access
                    break;
                case 'lab':
                    // Lab staff only has access to coding and analysis
                    navButtons.forEach(btn => {
                        const text = btn.textContent.trim();
                        if (!text.includes('Mã hóa') && !text.includes('Thử nghiệm') && !text.includes('Tổng quan')) {
                            btn.style.display = 'none';
                        }
                    });
                    break;
            }
            
            // Update header to show logged in user
            const loginSection = document.getElementById('loginSection');
            const userSection = document.getElementById('userSection');
            const userInfo = document.getElementById('userInfo');
            const userName = sessionStorage.getItem('userName');
            
            if (userName) {
                loginSection.classList.add('hidden');
                userSection.classList.remove('hidden');
                userSection.classList.add('flex');
                userInfo.textContent = userName;
            }
        }
        
        function logout() {
            sessionStorage.removeItem('userRole');
            sessionStorage.removeItem('userName');
            
            // Reset header display
            const loginSection = document.getElementById('loginSection');
            const userSection = document.getElementById('userSection');
            
            loginSection.classList.remove('hidden');
            userSection.classList.add('hidden');
            userSection.classList.remove('flex');
            
            // Clear login form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('userRole').value = '';
            
            // Reset navigation visibility
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                btn.style.display = 'block';
            });
            
            // Go back to dashboard
            showSection('dashboard');
            
            alert('Đã đăng xuất thành công!');
        }
        
        // Check for existing session on page load
        function checkUserSession() {
            const userRole = sessionStorage.getItem('userRole');
            if (userRole) {
                updateUIForRole(userRole);
            }
        }

        function filterCustomers() {
            const searchTerm = document.getElementById('searchCustomers').value.toLowerCase();
            const frequencyFilter = document.getElementById('filterFrequency').value;
            const dueStatusFilter = document.getElementById('filterDueStatus').value;
            const yearFilter = document.getElementById('filterYear').value;
            
            let filteredCustomers = customers.filter(customer => {
                // Search filter
                const matchesSearch = customer.name.toLowerCase().includes(searchTerm) ||
                                    customer.phone.includes(searchTerm) ||
                                    customer.email.toLowerCase().includes(searchTerm);
                
                // Frequency filter
                const matchesFrequency = !frequencyFilter || customer.frequency === frequencyFilter;
                
                // Year filter
                const matchesYear = !yearFilter || customer.contractYear === yearFilter;
                
                // Due status filter
                let matchesDueStatus = true;
                if (dueStatusFilter) {
                    const dueStatus = getDueDateStatus(customer.nextDueDate);
                    switch (dueStatusFilter) {
                        case 'overdue':
                            matchesDueStatus = dueStatus.text === 'Quá hạn';
                            break;
                        case 'due-soon':
                            matchesDueStatus = dueStatus.text === 'Sắp đến hạn';
                            break;
                        case 'due-month':
                            matchesDueStatus = dueStatus.text === 'Trong tháng';
                            break;
                        case 'on-time':
                            matchesDueStatus = dueStatus.text === 'Còn thời gian';
                            break;
                    }
                }
                
                return matchesSearch && matchesFrequency && matchesYear && matchesDueStatus;
            });
            
            // Update grid with filtered customers
            updateCustomersGridWithData(filteredCustomers);
            updateCustomerStats();
        }

        function updateCustomersGridWithData(customersData) {
            const grid = document.getElementById('customersGrid');
            if (customersData.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Không tìm thấy khách hàng nào</div>';
                return;
            }

            grid.innerHTML = customersData.map(customer => {
                const frequencyInfo = getFrequencyInfo(customer.frequency);
                const progressInfo = getYearlyProgress(customer);
                const dueDateStatus = getDueDateStatus(customer.nextDueDate);
                
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow ${dueDateStatus.urgent ? 'border-red-300 bg-red-50' : ''}">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-semibold text-gray-800 text-lg">${customer.name}</h3>
                                <p class="text-sm text-gray-600">${customer.phone}</p>
                                <p class="text-sm text-gray-600">${customer.email}</p>
                            </div>
                            <div class="text-right">
                                <span class="px-2 py-1 text-xs rounded-full ${frequencyInfo.color} block mb-1">
                                    ${frequencyInfo.text}
                                </span>
                                <span class="px-2 py-1 text-xs rounded-full ${dueDateStatus.color}">
                                    ${dueDateStatus.text}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Yearly Progress -->
                        <div class="mb-4">
                            <div class="flex justify-between text-sm text-gray-600 mb-2">
                                <span>Tiến độ năm ${customer.contractYear}</span>
                                <span>${customer.completedSamples}/${customer.totalSamplesPerYear}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${progressInfo.percentage}%"></div>
                            </div>
                        </div>
                        
                        <!-- Schedule Info -->
                        <div class="text-sm text-gray-600 mb-4 bg-gray-50 p-3 rounded-lg">
                            <div class="flex justify-between mb-1">
                                <span>Tần suất:</span>
                                <span class="font-medium">${frequencyInfo.description}</span>
                            </div>
                            <div class="flex justify-between mb-1">
                                <span>Lần tiếp theo:</span>
                                <span class="font-medium ${dueDateStatus.urgent ? 'text-red-600' : 'text-blue-600'}">${formatDate(customer.nextDueDate)}</span>
                            </div>
                            <div class="flex justify-between mb-1">
                                <span>Còn lại trong năm:</span>
                                <span class="font-medium">${customer.totalSamplesPerYear - customer.completedSamples} mẫu</span>
                            </div>
                            ${customer.linkedCodes && customer.linkedCodes.length > 0 ? `
                            <div class="flex justify-between">
                                <span>Mã liên kết:</span>
                                <span class="font-medium text-blue-600">${customer.linkedCodes.length} mã</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <!-- Latest Sample Status -->
                        ${customer.samples && customer.samples.length > 0 ? `
                        <div class="text-sm text-gray-600 mb-4 border-t pt-3">
                            <div class="font-medium mb-2">Mẫu gần nhất (${customer.samples[customer.samples.length - 1].quarter}):</div>
                            <div class="flex justify-between">
                                <span>Trạng thái:</span>
                                <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(customer.samples[customer.samples.length - 1].status)}">
                                    ${getStatusText(customer.samples[customer.samples.length - 1].status)}
                                </span>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="flex space-x-2">
                            <button onclick="openCustomerModal(${customer.id})" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700 transition-colors text-sm">
                                <i class="fas fa-edit mr-1"></i>Chi tiết
                            </button>
                            <button onclick="addNewSample(${customer.id})" class="bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700 transition-colors text-sm" title="Thêm mẫu mới">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="showQRCode(${customer.id})" class="bg-purple-600 text-white px-3 py-2 rounded-md hover:bg-purple-700 transition-colors text-sm" title="Tạo mã QR">
                                <i class="fas fa-qrcode"></i>
                            </button>
                            <button onclick="exportCustomerProfile(${customer.id})" class="bg-orange-600 text-white px-3 py-2 rounded-md hover:bg-orange-700 transition-colors text-sm">
                                <i class="fas fa-file-export"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateCustomerStats() {
            const totalCustomers = customers.length;
            let overdueCount = 0;
            let dueSoonCount = 0;
            let totalCompletedSamples = 0;
            
            customers.forEach(customer => {
                const dueStatus = getDueDateStatus(customer.nextDueDate);
                if (dueStatus.text === 'Quá hạn') overdueCount++;
                if (dueStatus.text === 'Sắp đến hạn') dueSoonCount++;
                totalCompletedSamples += customer.completedSamples;
            });
            
            document.getElementById('totalCustomers').textContent = totalCustomers;
            document.getElementById('overdueCustomers').textContent = overdueCount;
            document.getElementById('dueSoonCustomers').textContent = dueSoonCount;
            document.getElementById('completedSamples').textContent = totalCompletedSamples;
        }

        // Show notification function
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            notification.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full opacity-0`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full', 'opacity-0');
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }

        // Update modal linked codes display
        function updateModalLinkedCodes(customer) {
            const container = document.getElementById('modalLinkedCodes');
            
            if (!customer.linkedCodes || customer.linkedCodes.length === 0) {
                container.innerHTML = '<span class="text-gray-500 text-sm">Chưa có mã liên kết nào</span>';
                return;
            }
            
            container.innerHTML = customer.linkedCodes.map(code => {
                const codingFile = codingFiles.find(f => f.fileCode === code);
                const resultFile = resultFiles.find(f => f.linkedCode === code);
                
                return `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 min-w-0">
                        <div class="font-mono text-sm font-bold text-blue-800">${code}</div>
                        <div class="text-xs text-gray-600 mt-1">
                            ${codingFile ? `📁 ${codingFile.name.substring(0, 20)}...` : 'File mã hóa không tìm thấy'}
                        </div>
                        <div class="text-xs text-gray-600">
                            ${resultFile ? `📊 ${resultFile.name.substring(0, 20)}...` : 'Chưa có file kết quả'}
                        </div>
                        <div class="text-xs text-blue-600 mt-1">
                            ${codingFile ? formatDate(codingFile.uploadDate.toISOString().split('T')[0]) : 'N/A'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update samples history to show linked codes
        function updateModalSamplesHistory(customer) {
            const container = document.getElementById('modalSamplesHistory');
            
            if (!customer.samples || customer.samples.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">Chưa có mẫu nào</div>';
                return;
            }
            
            container.innerHTML = customer.samples.map((sample, index) => `
                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h5 class="font-medium text-gray-800">${sample.quarter}</h5>
                            <div class="flex items-center space-x-2 mt-1">
                                <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(sample.status)}">
                                    ${getStatusText(sample.status)}
                                </span>
                                ${sample.linkedCode ? `
                                <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 font-mono">
                                    ${sample.linkedCode}
                                </span>
                                ` : ''}
                            </div>
                        </div>
                        <button onclick="deleteSample(${customer.id}, ${index})" class="text-red-600 hover:text-red-800 text-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Ngày nhận mẫu</label>
                            <input type="date" value="${sample.receiveDate}" onchange="updateSampleField(${customer.id}, ${index}, 'receiveDate', this.value)" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Ngày thử nghiệm</label>
                            <input type="date" value="${sample.testDate}" onchange="updateSampleField(${customer.id}, ${index}, 'testDate', this.value)" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Ngày trả kết quả</label>
                            <input type="date" value="${sample.resultDate}" onchange="updateSampleField(${customer.id}, ${index}, 'resultDate', this.value)" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Chất lượng mẫu</label>
                            <select value="${sample.sampleQuality}" onchange="updateSampleField(${customer.id}, ${index}, 'sampleQuality', this.value)" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <option value="">Chọn đánh giá</option>
                                <option value="excellent" ${sample.sampleQuality === 'excellent' ? 'selected' : ''}>Xuất sắc</option>
                                <option value="good" ${sample.sampleQuality === 'good' ? 'selected' : ''}>Tốt</option>
                                <option value="average" ${sample.sampleQuality === 'average' ? 'selected' : ''}>Trung bình</option>
                                <option value="poor" ${sample.sampleQuality === 'poor' ? 'selected' : ''}>Kém</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Kết quả thử nghiệm</label>
                            <select value="${sample.testResult}" onchange="updateSampleField(${customer.id}, ${index}, 'testResult', this.value)" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <option value="">Chọn kết quả</option>
                                <option value="pass" ${sample.testResult === 'pass' ? 'selected' : ''}>Đạt</option>
                                <option value="fail" ${sample.testResult === 'fail' ? 'selected' : ''}>Không đạt</option>
                                <option value="conditional" ${sample.testResult === 'conditional' ? 'selected' : ''}>Cần theo dõi</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Nhận xét</label>
                        <textarea rows="2" placeholder="Nhập nhận xét..." onchange="updateSampleField(${customer.id}, ${index}, 'comments', this.value)" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">${sample.comments}</textarea>
                    </div>
                </div>
            `).join('');
        }

        // Daily sample count management
        function updateDailySampleCount(count) {
            const today = new Date().toDateString();
            let dailyData = JSON.parse(localStorage.getItem('dailySampleData') || '{}');
            
            if (!dailyData[today]) {
                dailyData[today] = 0;
            }
            
            dailyData[today] += count;
            localStorage.setItem('dailySampleData', JSON.stringify(dailyData));
            
            // Update display
            document.getElementById('dailySampleCount').textContent = dailyData[today];
        }
        
        function loadDailySampleCount() {
            const today = new Date().toDateString();
            const dailyData = JSON.parse(localStorage.getItem('dailySampleData') || '{}');
            const todayCount = dailyData[today] || 0;
            
            document.getElementById('dailySampleCount').textContent = todayCount;
        }

        // Initialize QR scan handling
        document.addEventListener('DOMContentLoaded', function() {
            updateDashboard();
            setupFileHandlers();
            loadSampleCustomers();
            updateCustomersGrid();
            updateCustomerStats();
            loadDailySampleCount(); // Load today's sample count
            handleQRScan(); // Handle QR code access
            checkUserSession(); // Check for existing login session
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'967a0cac610f5dee',t:'MTc1MzkzMjk2Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
